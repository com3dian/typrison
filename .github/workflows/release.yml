name: Build Release Packages

on:
  release:
    types: [created, published]
  workflow_dispatch: # Allows manual trigger for testing

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      id: install-qt
      with:
        version: '6.8.0'
        host: 'mac'
        target: 'desktop'
        arch: 'clang_64'
        cache: true
    
    - name: Verify Qt installation
      run: |
        echo "Checking Qt installation..."
        echo "Qt6_DIR: $Qt6_DIR"
        echo "CMAKE_PREFIX_PATH: $CMAKE_PREFIX_PATH"
        if [ -n "$Qt6_DIR" ] && [ -d "$Qt6_DIR" ]; then
          echo "Qt6_DIR exists: $Qt6_DIR"
          ls -la "$Qt6_DIR" || true
        fi
        if [ -n "$CMAKE_PREFIX_PATH" ]; then
          echo "CMAKE_PREFIX_PATH: $CMAKE_PREFIX_PATH"
          find "$CMAKE_PREFIX_PATH" -name "Qt6Config.cmake" 2>/dev/null | head -1 || echo "Qt6Config.cmake not found in CMAKE_PREFIX_PATH"
        fi
    
    - name: Configure CMake
      run: |
        cd typistprison
        mkdir -p build-release
        cd build-release
        echo "Environment variables:"
        env | grep -i qt || true
        echo "Qt6_DIR: $Qt6_DIR"
        echo "CMAKE_PREFIX_PATH: $CMAKE_PREFIX_PATH"
        echo "Running CMake configuration..."
        
        # Build CMake command
        CMAKE_CMD="cmake -DCMAKE_BUILD_TYPE=Release -G \"Unix Makefiles\""
        
        # Add Qt path if available
        if [ -n "$Qt6_DIR" ]; then
          CMAKE_CMD="$CMAKE_CMD -DQt6_DIR=\"$Qt6_DIR\""
          echo "Using Qt6_DIR: $Qt6_DIR"
        elif [ -n "$CMAKE_PREFIX_PATH" ]; then
          CMAKE_CMD="$CMAKE_CMD -DCMAKE_PREFIX_PATH=\"$CMAKE_PREFIX_PATH\""
          echo "Using CMAKE_PREFIX_PATH: $CMAKE_PREFIX_PATH"
        else
          echo "Warning: No Qt path found in environment!"
        fi
        
        CMAKE_CMD="$CMAKE_CMD .."
        echo "CMake command: $CMAKE_CMD"
        
        # Run CMake and capture output
        eval $CMAKE_CMD 2>&1 | tee cmake_output.log
        CMAKE_EXIT_CODE=${PIPESTATUS[0]}
        
        if [ $CMAKE_EXIT_CODE -ne 0 ]; then
          echo "ERROR: CMake configuration failed with exit code $CMAKE_EXIT_CODE"
          cat cmake_output.log
          exit 1
        fi
        
        echo "CMake configuration completed. Checking for Makefile..."
        if [ ! -f "Makefile" ]; then
          echo "ERROR: Makefile not found after CMake configuration!"
          cat cmake_output.log
          exit 1
        fi
        echo "Makefile found successfully!"
    
    - name: Build
      run: |
        cd typistprison/build-release
        if [ ! -f "Makefile" ]; then
          echo "Error: No Makefile found! CMake configuration may have failed."
          exit 1
        fi
        cmake --build . --config Release -j$(sysctl -n hw.ncpu)
    
    - name: Find .app bundle
      id: find_app
      run: |
        APP_PATH=$(find typistprison/build-release -name "*.app" -type d | head -n 1)
        echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT
        echo "Found app at: $APP_PATH"
    
    - name: Deploy Qt dependencies and create DMG
      run: |
        APP_PATH="${{ steps.find_app.outputs.app_path }}"
        macdeployqt "$APP_PATH" -dmg
        DMG_PATH="${APP_PATH%.app}.dmg"
        echo "DMG created at: $DMG_PATH"
        ls -lh "$(dirname $DMG_PATH)"
    
    - name: Rename DMG with version
      id: rename_dmg
      run: |
        APP_PATH="${{ steps.find_app.outputs.app_path }}"
        DMG_PATH="${APP_PATH%.app}.dmg"
        VERSION="${GITHUB_REF#refs/tags/}"
        if [ -z "$VERSION" ] || [ "$VERSION" == "$GITHUB_REF" ]; then
          VERSION="dev"
        fi
        NEW_NAME="TypistPrison-${VERSION}-macOS.dmg"
        mv "$DMG_PATH" "typistprison/build-release/$NEW_NAME"
        echo "dmg_name=$NEW_NAME" >> $GITHUB_OUTPUT
        echo "dmg_path=typistprison/build-release/$NEW_NAME" >> $GITHUB_OUTPUT
    
    - name: Upload DMG artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-dmg
        path: ${{ steps.rename_dmg.outputs.dmg_path }}
    
    - name: Upload DMG to release
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ${{ steps.rename_dmg.outputs.dmg_path }}
        asset_name: ${{ steps.rename_dmg.outputs.dmg_name }}
        asset_content_type: application/x-apple-diskimage

  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      id: install-qt
      with:
        version: '6.8.0'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
        cache: true
    
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    
    - name: Install Ninja
      run: choco install ninja -y
    
    - name: Configure CMake
      shell: bash
      run: |
        cd typistprison
        mkdir -p build-release
        cd build-release
        echo "Environment variables:"
        env | grep -i qt || true
        echo "Qt6_DIR: $Qt6_DIR"
        echo "CMAKE_PREFIX_PATH: $CMAKE_PREFIX_PATH"
        
        # Build CMake command
        CMAKE_CMD="cmake -DCMAKE_BUILD_TYPE=Release -G \"Ninja\""
        
        # Add Qt path if available
        if [ -n "$Qt6_DIR" ]; then
          CMAKE_CMD="$CMAKE_CMD -DQt6_DIR=\"$Qt6_DIR\""
          echo "Using Qt6_DIR: $Qt6_DIR"
        elif [ -n "$CMAKE_PREFIX_PATH" ]; then
          CMAKE_CMD="$CMAKE_CMD -DCMAKE_PREFIX_PATH=\"$CMAKE_PREFIX_PATH\""
          echo "Using CMAKE_PREFIX_PATH: $CMAKE_PREFIX_PATH"
        fi
        
        CMAKE_CMD="$CMAKE_CMD .."
        echo "CMake command: $CMAKE_CMD"
        
        # Run CMake
        eval $CMAKE_CMD 2>&1 | tee cmake_output.log
        CMAKE_EXIT_CODE=${PIPESTATUS[0]}
        
        if [ $CMAKE_EXIT_CODE -ne 0 ]; then
          echo "ERROR: CMake configuration failed with exit code $CMAKE_EXIT_CODE"
          cat cmake_output.log
          exit 1
        fi
        
        echo "CMake configuration completed. Checking for build files..."
        if [ ! -f "build.ninja" ]; then
          echo "ERROR: build.ninja not found after CMake configuration!"
          cat cmake_output.log
          exit 1
        fi
        echo "build.ninja found successfully!"
    
    - name: Build
      shell: bash
      run: |
        cd typistprison/build-release
        if [ ! -f "build.ninja" ]; then
          echo "Error: No build.ninja found! CMake configuration may have failed."
          exit 1
        fi
        cmake --build . --config Release
    
    - name: Find EXE
      id: find_exe
      shell: bash
      run: |
        EXE_PATH=$(find typistprison/build-release -name "*.exe" -type f | head -n 1)
        echo "exe_path=$EXE_PATH" >> $GITHUB_OUTPUT
        echo "Found exe at: $EXE_PATH"
        EXE_DIR=$(dirname "$EXE_PATH")
        echo "exe_dir=$EXE_DIR" >> $GITHUB_OUTPUT
    
    - name: Deploy Qt dependencies
      shell: bash
      run: |
        windeployqt "${{ steps.find_exe.outputs.exe_path }}"
        echo "Deployed files:"
        ls -lh "${{ steps.find_exe.outputs.exe_dir }}"
    
    - name: Create distributable package
      id: create_package
      shell: bash
      run: |
        VERSION="${GITHUB_REF#refs/tags/}"
        if [ -z "$VERSION" ] || [ "$VERSION" == "$GITHUB_REF" ]; then
          VERSION="dev"
        fi
        PACKAGE_NAME="TypistPrison-${VERSION}-Windows"
        PACKAGE_DIR="typistprison/build-release/$PACKAGE_NAME"
        mkdir -p "$PACKAGE_DIR"
        cp -r "${{ steps.find_exe.outputs.exe_dir }}"/* "$PACKAGE_DIR/"
        
        # Create zip
        cd typistprison/build-release
        7z a "${PACKAGE_NAME}.zip" "$PACKAGE_NAME"
        
        echo "package_name=${PACKAGE_NAME}.zip" >> $GITHUB_OUTPUT
        echo "package_path=typistprison/build-release/${PACKAGE_NAME}.zip" >> $GITHUB_OUTPUT
    
    - name: Upload Windows package artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-exe
        path: ${{ steps.create_package.outputs.package_path }}
    
    - name: Upload package to release
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ${{ steps.create_package.outputs.package_path }}
        asset_name: ${{ steps.create_package.outputs.package_name }}
        asset_content_type: application/zip

  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libgl1-mesa-dev \
          libglib2.0-dev \
          libxkbcommon-x11-0 \
          libxkbcommon-dev
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      id: install-qt
      with:
        version: '6.5.3'
        host: 'linux'
        target: 'desktop'
        arch: 'gcc_64'
        cache: false
    
    - name: Configure CMake
      run: |
        cd typistprison
        mkdir -p build-release
        cd build-release
        echo "Environment variables:"
        env | grep -i qt || true
        echo "Qt6_DIR: $Qt6_DIR"
        echo "CMAKE_PREFIX_PATH: $CMAKE_PREFIX_PATH"
        
        # Build CMake command
        CMAKE_CMD="cmake -DCMAKE_BUILD_TYPE=Release -G \"Ninja\""
        
        # Add Qt path if available
        if [ -n "$Qt6_DIR" ]; then
          CMAKE_CMD="$CMAKE_CMD -DQt6_DIR=\"$Qt6_DIR\""
          echo "Using Qt6_DIR: $Qt6_DIR"
        elif [ -n "$CMAKE_PREFIX_PATH" ]; then
          CMAKE_CMD="$CMAKE_CMD -DCMAKE_PREFIX_PATH=\"$CMAKE_PREFIX_PATH\""
          echo "Using CMAKE_PREFIX_PATH: $CMAKE_PREFIX_PATH"
        else
          echo "Warning: No Qt path found in environment!"
        fi
        
        CMAKE_CMD="$CMAKE_CMD .."
        echo "CMake command: $CMAKE_CMD"
        
        # Run CMake and capture output
        eval $CMAKE_CMD 2>&1 | tee cmake_output.log
        CMAKE_EXIT_CODE=${PIPESTATUS[0]}
        
        if [ $CMAKE_EXIT_CODE -ne 0 ]; then
          echo "ERROR: CMake configuration failed with exit code $CMAKE_EXIT_CODE"
          cat cmake_output.log
          exit 1
        fi
        
        echo "CMake configuration completed. Checking for build files..."
        if [ ! -f "build.ninja" ]; then
          echo "ERROR: build.ninja not found after CMake configuration!"
          cat cmake_output.log
          exit 1
        fi
        echo "build.ninja found successfully!"
    
    - name: Build
      run: |
        cd typistprison/build-release
        if [ ! -f "build.ninja" ]; then
          echo "Error: No build.ninja found! CMake configuration may have failed."
          exit 1
        fi
        cmake --build . --config Release
    
    - name: Find executable
      id: find_exe
      run: |
        EXE_PATH=$(find typistprison/build-release -name "typistprison" -type f -executable | head -n 1)
        if [ -z "$EXE_PATH" ]; then
          # Try alternative locations
          EXE_PATH=$(find typistprison/build-release -type f -executable | grep -v ".so" | head -n 1)
        fi
        echo "exe_path=$EXE_PATH" >> $GITHUB_OUTPUT
        echo "Found executable at: $EXE_PATH"
        EXE_DIR=$(dirname "$EXE_PATH")
        echo "exe_dir=$EXE_DIR" >> $GITHUB_OUTPUT
    
    - name: Create distributable package
      id: create_package
      run: |
        VERSION="${GITHUB_REF#refs/tags/}"
        if [ -z "$VERSION" ] || [ "$VERSION" == "$GITHUB_REF" ]; then
          VERSION="dev"
        fi
        EXE_PATH="${{ steps.find_exe.outputs.exe_path }}"
        EXE_DIR="${{ steps.find_exe.outputs.exe_dir }}"
        PACKAGE_NAME="TypistPrison-${VERSION}-Linux"
        PACKAGE_DIR="typistprison/build-release/$PACKAGE_NAME"
        
        mkdir -p "$PACKAGE_DIR"
        
        # Copy executable
        cp "$EXE_PATH" "$PACKAGE_DIR/"
        chmod +x "$PACKAGE_DIR/typistprison"
        
        # Find and copy Qt libraries
        if [ -n "$Qt6_DIR" ]; then
          QT_BASE=$(dirname "$Qt6_DIR")
          QT_LIB_DIR="$QT_BASE/lib"
          if [ -d "$QT_LIB_DIR" ]; then
            mkdir -p "$PACKAGE_DIR/lib"
            # Copy required Qt libraries
            for lib in Qt6Core Qt6Gui Qt6Widgets Qt6Network Qt6Concurrent; do
              find "$QT_LIB_DIR" -name "lib${lib}.so*" -exec cp {} "$PACKAGE_DIR/lib/" \; 2>/dev/null || true
            done
          fi
          
          # Copy Qt plugins
          QT_PLUGINS_DIR="$QT_BASE/plugins"
          if [ -d "$QT_PLUGINS_DIR" ]; then
            mkdir -p "$PACKAGE_DIR/plugins"
            cp -r "$QT_PLUGINS_DIR"/* "$PACKAGE_DIR/plugins/" 2>/dev/null || true
          fi
        fi
        
        # Create a run script that sets up the environment
        {
          echo '#!/bin/bash'
          echo 'SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"'
          echo 'export LD_LIBRARY_PATH="$SCRIPT_DIR/lib:$LD_LIBRARY_PATH"'
          echo 'export QT_PLUGIN_PATH="$SCRIPT_DIR/plugins"'
          echo '"$SCRIPT_DIR/typistprison" "$@"'
        } > "$PACKAGE_DIR/run.sh"
        chmod +x "$PACKAGE_DIR/run.sh"
        
        # Create README
        cat > "$PACKAGE_DIR/README.txt" << EOF
TypistPrison ${VERSION} for Linux

To run:
  ./run.sh

Or directly:
  export LD_LIBRARY_PATH=./lib:\$LD_LIBRARY_PATH
  ./typistprison
EOF
        
        # Create tarball
        cd typistprison/build-release
        tar -czf "${PACKAGE_NAME}.tar.gz" "$PACKAGE_NAME"
        
        echo "package_name=${PACKAGE_NAME}.tar.gz" >> $GITHUB_OUTPUT
        echo "package_path=typistprison/build-release/${PACKAGE_NAME}.tar.gz" >> $GITHUB_OUTPUT
    
    - name: Upload Linux package artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-app
        path: ${{ steps.create_package.outputs.package_path }}
    
    - name: Upload package to release
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ${{ steps.create_package.outputs.package_path }}
        asset_name: ${{ steps.create_package.outputs.package_name }}
        asset_content_type: application/octet-stream
